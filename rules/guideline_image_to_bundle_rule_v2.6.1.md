# Rule: Guideline Text/Image ‚Üí FHIR JSON Bundle Transformation

## üéØ Purpose
This rule defines the complete workflow and prompt specification to convert **clinical guideline content** ‚Äî provided either as **diagram images** or **textual step-by-step descriptions** ‚Äî into validated **FHIR JSON Bundles**. It ensures consistent extraction, conversion, validation, integrity checking, and autofix processes so that the final output is a valid and self-contained Bundle (FHIR R4) ready for CDS implementation.

---

## üß† System Prompt (for the assistant/automation)

You are a **clinical guideline transformation expert** specialized in **FHIR/HL7, CDS, and guideline representation**. Your task is to transform a single clinical guideline ‚Äî provided either as an **image diagram** or a **structured text file describing the decision flow** ‚Äî into a validated FHIR JSON Bundle.

### Your responsibilities:
1. **Extract** structured content from the input (image or text): decision nodes, actions, diagnoses, data collection elements.
2. **Generate a structured Markdown file** following the Guideline Markdown Template.
3. **Produce a FHIR JSON Bundle** containing PlanDefinition, Library, ActivityDefinition, and Questionnaire.
4. **Run integrity verification** using `tools/integrity_check.py` and `tools/validate_bundle_integrity.py`.
5. **Ensure canonical integrity** ‚Äî all references resolve within the Bundle or are declared as external dependencies.
6. **Validate** the Bundle using the HL7 FHIR Validator until **0 validation errors** remain.

### Constraints
- Do **not** alter or invent clinical meaning.
- Use only standard code systems (ICD-10, LOINC, SNOMED). Missing codes ‚Üí mark TODO.
- Maintain machine-parseable Markdown with consistent naming conventions.

---

## üìÇ Directory and File Structure Convention

Each guideline must have its own subdirectory under `/guidelines/<base>/`.

For example, if the input file is:
```
fever-diagram.png
```
Then all generated artifacts must be stored in:
```
/guidelines/fever-diagram/
```

### Directory contents:
```
/guidelines/fever-diagram/
‚îú‚îÄ‚îÄ fever-diagram.md
‚îú‚îÄ‚îÄ fever-diagram.bundle.orig.json
‚îú‚îÄ‚îÄ fever-diagram.bundle.json
‚îú‚îÄ‚îÄ fever-diagram.integrity.report.txt
‚îú‚îÄ‚îÄ fever-diagram.bundle.report.txt
‚îú‚îÄ‚îÄ fever-diagram.bundle.autofix.log
‚îî‚îÄ‚îÄ fever-diagram.bundle.remediation.txt
```

Each run of the workflow should automatically create this subfolder if it does not exist.

---

## üìÑ Input Types and Expected Outputs

### Accepted Inputs
| Input Type | Description | Example |
|-------------|--------------|----------|
| `image` | Clinical guideline diagram (PNG, JPG, SVG) | `fever-diagram.png` |
| `text` | Structured or semi-structured text file describing decision steps, questions, and actions | `fever-guideline.txt` |

The automation must parse both forms equivalently: extract the logical decision flow, branching conditions, and resulting actions.

### Output Files per Input
| Output | Description |
|---------|-------------|
| `<base>.md` | Structured Markdown guideline |
| `<base>.bundle.json` | FHIR JSON Bundle (R4) |
| `<base>.integrity.report.txt` | Report generated by integrity validator |
| `<base>.bundle.report.txt` | HL7 Validator output |
| `<base>.bundle.autofix.log` | Autofix log (if applied) |
| `<base>.bundle.remediation.txt` | Manual fix report (if critical errors remain) |

---

## ü™∂ Guideline Markdown Template

### YAML Front-Matter
```yaml
id: fever-guideline
title: Evaluation of Fever
description: Diagnostic decision tree for fever causes.
version: 1.0.0
date: YYYY-MM-DD
authors:
  - name: <author>
fhirVersion: "4.0.1"
```

### Sections
- **Context / Scope**: textual background
- **Flow**: list of steps/questions and their logic
- **Actions**: list of resulting actions or recommendations
- **Notes / TODO**: pending code mappings, references

#### Example Flow
```markdown
1. stepId: recentTravel
   question: "Recent travel abroad?"
   type: boolean
   next:
     true: stepId=travelIncubation
     false: stepId=hospitalizationCheck

2. stepId: travelIncubation
   question: "Incubation period since return"
   type: choice
   answers:
     - code: lt21
       display: "< 21 days"
       next: action=propose-malaria
     - code: gt21
       display: "> 21 days"
       next: action=propose-tb
```

---

## üß© Step: Lightweight Markdown Integrity Check (using `tools/integrity_check.py`)

**Purpose:**  
Perform a quick integrity verification of the generated Markdown (`.md`) file before any conversion to JSON Bundle.
This ensures the Markdown contains valid front-matter, expected structure, and an identifiable source trace.

**Checks performed:**
- Parse simple YAML front-matter keys (`id`, `title`, `date`, `authors`, `fhirVersion`)
- Extract all `stepId` tokens within the Markdown Flow section
- Detect a ‚ÄúGenerated from ‚Ä¶‚Äù line (best-effort origin trace)
- If the front-matter includes `source-checksum: <sha256>`, compare SHA256 of the original image/text file against it

**Usage:**
```bash
python3 tools/integrity_check.py --md <guideline.md> \
  [--source <diagrams/foo.txt|diagrams/foo.png>] \
  [--report <out.txt>]
```

**Exit codes:**
| Code | Meaning |
|------|----------|
| 0 | All critical checks passed |
| 1 | Critical issues found (invalid or missing fields) |
| 2 | File missing or invalid usage |

**Typical pipeline usage:**
This check runs immediately after Markdown generation (Step 2 in the 5-step pipeline).  
If exit code ‚â† 0 ‚Üí stop and fix Markdown or source before proceeding to Bundle generation.

---

## üßÆ Step: Pre-Validation Integrity Check (using `tools/validate_bundle_integrity.py`)

**Purpose:**  
Verify the generated artifacts (Markdown and Bundle) are internally consistent and that the Bundle reflects the Markdown before any autofix or HL7 validation runs.

### Notes on the improved toolchain
- `tools/validate_bundle_integrity.py` now supports validating **Markdown (front-matter and extracted `stepId`s)**, **Bundle JSON**, and **cross-checks** between them.
- Use `tools/post_md_checks.py` as a small wrapper that converters can call immediately after producing the Markdown (and bundle if available). The wrapper writes `<base>.integrity.report.txt` next to the guideline files.

### Recommended Invocations

**When both Markdown and Bundle are available (recommended):**
```bash
python3 tools/validate_bundle_integrity.py --md <base>.md --bundle <base>.bundle.json --output <base>.integrity.report.txt
```

**Using the wrapper helper (recommended for converters):**
```bash
python3 tools/post_md_checks.py --md <base>.md --bundle <base>.bundle.json
```

**If only Markdown is available (no bundle yet):**
```bash
python3 tools/validate_bundle_integrity.py --md <base>.md --output <base>.integrity.report.txt
```

### Checks Performed
- Presence of required resources in the Bundle (PlanDefinition, Library, Questionnaire, ‚â•1 ActivityDefinition) when Bundle is provided
- YAML front-matter presence and required keys (`id`, `title`, `fhirVersion`)
- Extraction of `stepId`s from the Markdown Flow
- `linkId` ‚Üî `stepId` mapping (Questionnaire linkIds vs Markdown stepIds)
- Canonical and reference consistency inside the Bundle
- ID and naming pattern conformity (e.g., `<id>-plan`, `<id>-bundle`)
- Library completeness (`type`, placeholder `content`)
- Orphan or unresolved references and unused resources

### Outcome Handling
- ‚úÖ **No critical errors**: proceed to autofix & HL7 Validator step
- ‚ö†Ô∏è **Warnings**: review report and decide if manual edits or autofix are needed
- ‚ùå **Critical errors**: stop and fix Markdown/Bundle; examine `<base>.integrity.report.txt`

### Report Output
- The tool writes a detailed report to `<base>.integrity.report.txt`
- Exits with code `0` (pass) or `1` (fail)

### Implementation Notes
- The Markdown parser extracts YAML front-matter and searches for `stepId` tokens in the Flow section.
- For robust YAML parsing, consider using `PyYAML` and enforcing strict schema.
- The cross-check lists any `stepId`s present in Markdown but missing from `Questionnaire.linkId`s (and vice versa) as warnings.

---

## üß© FHIR JSON Bundle Generation Rules

| Resource | Rules |
|-----------|-------|
| **Bundle** | `resourceType: "Bundle"`, `type: "collection"`, `id: <id>-bundle` |
| **PlanDefinition** | `id: <id>-plan`, references Library + ActivityDefinitions |
| **Library** | `id: <id>-library`, `type: logic-library`, `content` = placeholder base64 CQL |
| **Questionnaire** | `id: <id>-questionnaire`, `linkId` = `stepId` |
| **ActivityDefinition** | `id: <id>-activity-<actionId>`, kind = `ServiceRequest` or `Task` |

Use URN UUIDs for all internal canonical references: `urn:uuid:<uuid>`.

---

## ‚úÖ Integrity Checks (Markdown ‚Üí JSON Bundle)

Before validation, ensure:
- Bundle includes at least: PlanDefinition, Library, Questionnaire, ‚â•1 ActivityDefinition
- All resource IDs follow `<id>-<suffix>` pattern
- All canonical and definitionCanonical links resolve within the Bundle
- Every Bundle.entry has a valid `fullUrl`
- Library contains `type` and placeholder `content`
- Questionnaire items cover all `stepId`s from the Flow

Failures are classified as **auto-fixable** or **manual remediation**.

---

## üîß Autofix Rules

| Issue | Auto-Fix |
|--------|-----------|
| Missing `fullUrl` | Add `urn:uuid:<uuid>` |
| Example URLs | Replace `https://example.org/...` ‚Üí corresponding `urn:uuid` |
| Library missing `type` | Add `logic-library` CodeableConcept |
| Library missing `content` | Add base64 placeholder CQL |
| ID too long | Truncate using deterministic hash suffix |

Every modification must be logged to `<base>.bundle.autofix.log`.

---

## üß™ HL7 Validator Integration

### Run validator
```bash
java -jar tools/validator_cli.jar -version 4.0.1 \
  -output <base>.bundle.report.txt <base>.bundle.json
```

### Validation loop
1. Run validator ‚Üí parse report
2. If errors:
   - Apply autofix (if applicable)
   - Re-run validator (max 3 times)
3. If critical errors persist ‚Üí write remediation report and stop

Success condition: **0 validation errors** in the final Bundle.

---

## ‚öôÔ∏è Execution Workflow

### Mapped 5-step conversion process (strict alignment with requested workflow)

This section enforces the exact 5-step process: Markdown ‚Üí MD check ‚Üí MD‚ÜíBundle conversion ‚Üí MD‚ÜîBundle integrity checks ‚Üí final review.

**Step 1 ‚Äî Convert source (PNG | TXT) ‚Üí Markdown**

### üß¨ Diagnostic Guideline (TXT) Conversion Logic

**Purpose:**  
Handle conversion of *text-based diagnostic guidelines* (TXT) into structured Markdown and later into FHIR JSON Bundle ‚Äî aligned with HL7 examples for diagnostic pathways.

**Reference artifacts:**
- `PlanDefinition-activity-example-proposediagnosis-pd.ttl`
- `ActivityDefinition-activity-example-proposediagnosis-ad.ttl`
- `ActivityDefinition-cpg-proposediagnosistask-activitydefinition.ttl`
- `Library-proposediagnosis-library.ttl`
- `Questionnaire-activity-example-collectinformation-questionnaire.ttl`
- `PlanDefinition-chf-pathway.ttl`
- `PlanDefinition-cc-cpg-plan-ckd.ttl`
- `PlanDefinition-va-ckd-recommendations.ttl`

These resources illustrate how *diagnostic suggestion actions* and *information collection tasks* fit within HL7 CDS pathways.

---

#### Conversion heuristics for TXT guidelines

1. **Identify action verbs and triggers:**
   - ‚ÄúCheck‚Äù, ‚ÄúAssess‚Äù, ‚ÄúCollect‚Äù, ‚ÄúOrder‚Äù, ‚ÄúDiagnose‚Äù, ‚ÄúPropose‚Äù, ‚ÄúEvaluate‚Äù, ‚ÄúIf/Then‚Äù.
   - Map to FHIR resource roles:

     | Keyword | FHIR Resource | Example |
     |----------|----------------|----------|
     | *collect / assess* | `Questionnaire` / `ActivityDefinition` | Data collection step |
     | *propose diagnosis* | `ActivityDefinition` | Diagnostic suggestion |
     | *if/then condition* | `PlanDefinition.action.condition` | Conditional branching |
     | *order / test / measure* | `ServiceRequest` | Diagnostic test action |

2. **Extract diagnostic logic:**
   For each decision node in text, create a Markdown step block:
   ```markdown
   - stepId: checkFever
     question: "Does the patient have fever (>38¬∞C)?"
     type: boolean
     next:
       true: stepId=orderWBC
       false: stepId=checkOtherSymptoms
   ```

3. **Generate supporting resources:**
   - `PlanDefinition`: defines the overall diagnostic pathway and branching.
   - `ActivityDefinition`: one per diagnostic or collection action.
   - `Questionnaire`: defines all patient data questions inferred from the text.
   - `Library`: placeholder for logic (CQL expression), e.g., for threshold calculations.

4. **Maintain traceability:**
   Include in Markdown YAML:
   ```yaml
   source-type: text
   source-file: diagnostic-guideline.txt
   source-checksum: <sha256>
   ```
   And at the end of the file:
   ```
   Generated from diagnostic-guideline.txt
   ```

5. **Mapping considerations (HL7 alignment):**
   - `PlanDefinition.action.code` ‚Üí use `http://hl7.org/fhir/CodeSystem/action-type` or `http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-action-type`.
   - `ActivityDefinition.kind` ‚Üí `ServiceRequest`, `Task`, or `Observation`.
   - `Questionnaire.item.linkId` = `stepId`.
   - Use `Library` for logical rules or scoring (e.g., CURB-65, SOFA).

6. **Validation expectations:**
   - Ensure `PlanDefinition` includes both *collect-information* and *propose-diagnosis* actions.
   - Ensure all referenced `ActivityDefinition` instances exist in the Bundle.
   - Ensure each Questionnaire covers all collected inputs.

---

#### Example (excerpt)
```
If patient has persistent cough ‚Üí collect sputum test
If sputum positive ‚Üí propose diagnosis: Tuberculosis
Else ‚Üí consider viral pneumonia
```

‚Üí Transforms into Markdown:

```markdown
1. stepId: coughCheck
   question: "Does the patient have persistent cough?"
   type: boolean
   next:
     true: stepId=sputumTest
     false: stepId=end

2. stepId: sputumTest
   action: collect-information
   question: "Collect sputum test result"
   type: observation
   next:
     positive: action=propose-tuberculosis
     negative: action=propose-viralpneumonia
```

---

### üß† Implementation guidance for AI

- Use rule-based parsing for `if`, `then`, `else`, `and`, `or` tokens to derive conditional tree.
- Group diagnostic propositions under `ActivityDefinition` resources with `kind: ServiceRequest`.
- Link to `Library` logic for derived expressions or scoring systems.
- Always output Markdown following the **same schema** as diagram-sourced guidelines to ensure downstream tools (integrity check, validator) work uniformly.

- Input: `/inputs/<file>` (image or text)
- Convert into `/guidelines/<base>/<base>.md` using the converter (OCR + parser for images, direct parse for text).
- Save intermediate artifacts in the guideline folder.

**Step 2 ‚Äî Check & finalize Markdown**
- Immediately run the lightweight Markdown integrity check:
```bash
python3 tools/integrity_check.py --md /guidelines/<base>/<base>.md --report /guidelines/<base>/<base>.integrity.report.txt
```
- If the integrity tool reports **critical errors**, **stop** and return to Step 1 to fix the source/Markdown. Do not proceed to Step 3 until the Markdown passes.
- If only **warnings**, document them in the integrity report and decide: either fix now (preferred) or proceed with explicit acceptance.

**Exit condition for Step 2:** `<base>.integrity.report.txt` exists and shows no critical errors (exit code 0).

**Step 3 ‚Äî Convert Markdown ‚Üí Bundle JSON**
- Only run after Step 2 passes.
- Run the Markdown-to-Bundle generator to create `/guidelines/<base>/<base>.bundle.json` and save the original as `.bundle.orig.json`.
- Ensure the generator follows the Bundle generation rules (resource ids, fullUrl URNs, Library content placeholders, Questionnaire linkIds mapping to stepIds).

**Step 4 ‚Äî Integrity check: Markdown ‚Üî Bundle**
- Run full integrity cross-check using both inputs:
```bash
python3 tools/validate_bundle_integrity.py --md /guidelines/<base>/<base>.md \
  --bundle /guidelines/<base>/<base>.bundle.json \
  --output /guidelines/<base>/<base>.integrity.report.txt
```
- The tool classifies issues into **critical**, **warnings**, and **info**.
  - **Critical**: missing PlanDefinition/Library/Questionnaire, broken canonicals, missing linkId mappings. If critical ‚Üí revert to Step 3 and fix conversion logic or Markdown content. Repeat Step 3 and Step 4 until no critical errors remain.
  - **Warnings**: missing codes, minor naming deviations, unused resources ‚Äî address as needed.

**Step 5 ‚Äî Final review & HL7 validation**
- After Step 4 passes (no critical errors), run autofix (deterministic fixes) then HL7 Validator:
```bash
# optional autofix stage (applies deterministic safe fixes)
python3 tools/autofix_bundle.py --bundle /guidelines/<base>/<base>.bundle.json --log /guidelines/<base>/<base>.bundle.autofix.log

# run HL7 validator
java -jar tools/validator_cli.jar -version 4.0.1 \
  -output /guidelines/<base>/<base>.bundle.report.txt /guidelines/<base>/<base>.bundle.json
```
- If HL7 validator returns **0 errors** ‚Üí accept and mark the bundle as final.
- If HL7 validator returns errors: classify them. If auto-fixable, apply deterministic fixes and re-run (up to N=3). If critical, create `/guidelines/<base>/<base>.bundle.remediation.txt` with manual remediation instructions and stop.

### Loop and governance rules
- **Do not** proceed to the next step while the current step has unresolved critical errors.
- When an error requires returning to a prior step, return **only to the immediately previous** step (i.e., on MD critical errors return to Step 1; on Bundle conversion errors return to Step 3). Avoid skipping steps to reduce churn.
- Keep all reports (`.integrity.report.txt`, `.bundle.report.txt`, `.bundle.autofix.log`) in the same guideline folder for auditability.

### Checklist automation hooks
- The pipeline should implement a simple state machine that tracks step status: `MD_CREATED`, `MD_VALIDATED`, `BUNDLE_CREATED`, `BUNDLE_INTEGRITY_PASSED`, `HL7_VALIDATED`.
- Each step writes a small status file `/guidelines/<base>/.state` and timestamp to aid automation restart and audit.

---

## üß∞ Implementation Guidelines
- **Languages:** Python or Node.js
- **Recommended modules:** `md_parser`, `bundle_builder`, `integrity_checker`, `autofix`, `validator_runner`, `reporter`
- **UUID Strategy:** Deterministic UUIDv5 using namespace `uuid.NAMESPACE_URL` and name `<bundle-id>|<resourceType>|<resource-id>`
- **Test cases:**
  - ‚úÖ Happy path ‚Äî valid Markdown ‚Üí passes first validation
  - ‚ö†Ô∏è Missing fullUrl ‚Äî fixed automatically
  - ‚ö†Ô∏è Missing Library.type/content ‚Äî fixed automatically
  - ‚öôÔ∏è Integrity check ‚Äî detects missing references or IDs before validation

---

## üì¶ Deliverables Checklist
- [ ] `/guidelines/<base>/<base>.md`
- [ ] `/guidelines/<base>/<base>.bundle.orig.json`
- [ ] `/guidelines/<base>/<base>.bundle.json`
- [ ] `/guidelines/<base>/<base>.integrity.report.txt`
- [ ] `/guidelines/<base>/<base>.bundle.report.txt`
- [ ] `/guidelines/<base>/<base>.bundle.autofix.log`
- [ ] `/guidelines/<base>/<base>.bundle.remediation.txt` (if needed)

---

## üßæ Change Log
- v2.6.1 ‚Äî Added documentation for `tools/integrity_check.py` as lightweight Markdown validator (Step 2) and aligned process with both tools (`integrity_check.py` + `validate_bundle_integrity.py`).

