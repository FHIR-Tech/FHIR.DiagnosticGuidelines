# Rule: Guideline Text/Image ‚Üí FHIR JSON Bundle Transformation

## üéØ Purpose
This rule defines the complete workflow and prompt specification to convert **clinical guideline content** ‚Äî provided either as **diagram images** or **textual step-by-step descriptions** ‚Äî into validated **FHIR JSON Bundles**. It ensures consistent extraction, conversion, validation, integrity checking, and autofix processes so that the final output is a valid and self-contained Bundle (FHIR R4) ready for CDS implementation.

---

## üß† System Prompt (for the assistant/automation)

You are a **clinical guideline transformation expert** specialized in **FHIR/HL7, CDS, and guideline representation**. Your task is to transform a single clinical guideline ‚Äî provided either as an **image diagram** or a **structured text file describing the decision flow** ‚Äî into a validated FHIR JSON Bundle.

### Your responsibilities:
1. **Extract** structured content from the input (image or text): decision nodes, actions, diagnoses, data collection elements.
2. **Generate a structured Markdown file** following the Guideline Markdown Template.
3. **Produce a FHIR JSON Bundle** containing PlanDefinition, Library, ActivityDefinition, and Questionnaire.
4. **Run integrity verification** using `tools/validate_bundle_integrity.py`.
5. **Ensure canonical integrity** ‚Äî all references resolve within the Bundle or are declared as external dependencies.
6. **Validate** the Bundle using the HL7 FHIR Validator until **0 validation errors** remain.

### Constraints
- Do **not** alter or invent clinical meaning.
- Use only standard code systems (ICD-10, LOINC, SNOMED). Missing codes ‚Üí mark TODO.
- Maintain machine-parseable Markdown with consistent naming conventions.

---

## üìÇ Directory and File Structure Convention

Each guideline must have its own subdirectory under `/guidelines/<base>/`.

For example, if the input file is:
```
fever-diagram.png
```
Then all generated artifacts must be stored in:
```
/guidelines/fever-diagram/
```

### Directory contents:
```
/guidelines/fever-diagram/
‚îú‚îÄ‚îÄ fever-diagram.md
‚îú‚îÄ‚îÄ fever-diagram.bundle.orig.json
‚îú‚îÄ‚îÄ fever-diagram.bundle.json
‚îú‚îÄ‚îÄ fever-diagram.integrity.report.txt
‚îú‚îÄ‚îÄ fever-diagram.bundle.report.txt
‚îú‚îÄ‚îÄ fever-diagram.bundle.autofix.log
‚îî‚îÄ‚îÄ fever-diagram.bundle.remediation.txt
```

Each run of the workflow should automatically create this subfolder if it does not exist.

---

## üìÑ Input Types and Expected Outputs

### Accepted Inputs
| Input Type | Description | Example |
|-------------|--------------|----------|
| `image` | Clinical guideline diagram (PNG, JPG, SVG) | `fever-diagram.png` |
| `text` | Structured or semi-structured text file describing decision steps, questions, and actions | `fever-guideline.txt` |

The automation must parse both forms equivalently: extract the logical decision flow, branching conditions, and resulting actions.

### Output Files per Input
| Output | Description |
|---------|-------------|
| `<base>.md` | Structured Markdown guideline |
| `<base>.bundle.json` | FHIR JSON Bundle (R4) |
| `<base>.integrity.report.txt` | Report generated by integrity validator |
| `<base>.bundle.report.txt` | HL7 Validator output |
| `<base>.bundle.autofix.log` | Autofix log (if applied) |
| `<base>.bundle.remediation.txt` | Manual fix report (if critical errors remain) |

---

## ü™∂ Guideline Markdown Template

### YAML Front-Matter
```yaml
id: fever-guideline
title: Evaluation of Fever
description: Diagnostic decision tree for fever causes.
version: 1.0.0
date: YYYY-MM-DD
authors:
  - name: <author>
fhirVersion: "4.0.1"
```

### Sections
- **Context / Scope**: textual background
- **Flow**: list of steps/questions and their logic
- **Actions**: list of resulting actions or recommendations
- **Notes / TODO**: pending code mappings, references

#### Example Flow
```markdown
1. stepId: recentTravel
   question: "Recent travel abroad?"
   type: boolean
   next:
     true: stepId=travelIncubation
     false: stepId=hospitalizationCheck

2. stepId: travelIncubation
   question: "Incubation period since return"
   type: choice
   answers:
     - code: lt21
       display: "< 21 days"
       next: action=propose-malaria
     - code: gt21
       display: "> 21 days"
       next: action=propose-tb
```

---

## üßÆ Step: Pre-Validation Integrity Check (using `tools/validate_bundle_integrity.py`)

Purpose: Verify the generated artifacts (Markdown and Bundle) are internally consistent and that the Bundle reflects the Markdown before any autofix or HL7 validation runs.

Notes on the improved toolchain:
- `tools/validate_bundle_integrity.py` now supports validating Markdown (front-matter and extracted `stepId`s), Bundle JSON, and cross-checks between them.
- Use `tools/post_md_checks.py` as a small wrapper that converters can call immediately after producing the Markdown (and bundle if available). The wrapper writes `<base>.integrity.report.txt` next to the guideline files.

Recommended invocations:

- If you have both Markdown and Bundle available (recommended):

```bash
python3 tools/validate_bundle_integrity.py --md <base>.md --bundle <base>.bundle.json --output <base>.integrity.report.txt
```

- Or using the wrapper helper (converters should call this after generating `.md`):

```bash
python3 tools/post_md_checks.py --md <base>.md --bundle <base>.bundle.json
```

- If you only have the Markdown (no bundle yet):

```bash
python3 tools/validate_bundle_integrity.py --md <base>.md --output <base>.integrity.report.txt
```

Checks performed (same intent as before, now with extra MD checks):
- Presence of required resources in the Bundle (PlanDefinition, Library, Questionnaire, ‚â•1 ActivityDefinition) when a Bundle is provided
- YAML front-matter presence and key checks in the Markdown (`id`, `title`, `fhirVersion`)
- Extraction of `stepId`s from the Markdown Flow
- `linkId` ‚Üî `stepId` mapping (Questionnaire linkIds vs Markdown stepIds)
- Canonical and reference consistency inside the Bundle
- ID and naming pattern conformity (e.g., `<id>-plan`, `<id>-bundle`)
- Library completeness (`type`, placeholder `content`)
- Orphan or unresolved references and unused resources

Outcome handling:
- ‚úÖ No critical errors: proceed to autofix & HL7 Validator step.
- ‚ö†Ô∏è Warnings: review report and decide if manual edits or autofix are needed.
- ‚ùå Critical errors: stop and fix the Markdown/Bundle; examine `<base>.integrity.report.txt` for details.

Report output:
- When `--output <file>` or `post_md_checks.py` is used, a detailed report is written to `<base>.integrity.report.txt` and the script exits with code `0` (pass) or `1` (fail).

Implementation notes:
- The Markdown parser in the tool extracts YAML front-matter and searches for `stepId` tokens in the Flow section. For robust YAML parsing of complex front-matter, consider installing `PyYAML` and updating the script to parse YAML strictly (future improvement).
- The cross-check will list any `stepId`s present in the Markdown but missing in the `Questionnaire.linkId`s (and vice versa) as warnings.

---

## üß© FHIR JSON Bundle Generation Rules

| Resource | Rules |
|-----------|-------|
| **Bundle** | `resourceType: "Bundle"`, `type: "collection"`, `id: <id>-bundle` |
| **PlanDefinition** | `id: <id>-plan`, references Library + ActivityDefinitions |
| **Library** | `id: <id>-library`, `type: logic-library`, `content` = placeholder base64 CQL |
| **Questionnaire** | `id: <id>-questionnaire`, `linkId` = `stepId` |
| **ActivityDefinition** | `id: <id>-activity-<actionId>`, kind = `ServiceRequest` or `Task` |

Use URN UUIDs for all internal canonical references: `urn:uuid:<uuid>`.

---

## ‚úÖ Integrity Checks (Markdown ‚Üí JSON Bundle)

Before validation, ensure:
- Bundle includes at least: PlanDefinition, Library, Questionnaire, ‚â•1 ActivityDefinition
- All resource IDs follow `<id>-<suffix>` pattern
- All canonical and definitionCanonical links resolve within the Bundle
- Every Bundle.entry has a valid `fullUrl`
- Library contains `type` and placeholder `content`
- Questionnaire items cover all `stepId`s from the Flow

Failures are classified as **auto-fixable** or **manual remediation**.

---

## üîß Autofix Rules

| Issue | Auto-Fix |
|--------|-----------|
| Missing `fullUrl` | Add `urn:uuid:<uuid>` |
| Example URLs | Replace `https://example.org/...` ‚Üí corresponding `urn:uuid` |
| Library missing `type` | Add `logic-library` CodeableConcept |
| Library missing `content` | Add base64 placeholder CQL |
| ID too long | Truncate using deterministic hash suffix |

Every modification must be logged to `<base>.bundle.autofix.log`.

---

## üß™ HL7 Validator Integration

### Run validator
```bash
java -jar tools/validator_cli.jar -version 4.0.1 \
  -output <base>.bundle.report.txt <base>.bundle.json
```

### Validation loop
1. Run validator ‚Üí parse report
2. If errors:
   - Apply autofix (if applicable)
   - Re-run validator (max 3 times)
3. If critical errors persist ‚Üí write remediation report and stop

Success condition: **0 validation errors** in the final Bundle.

---

## ‚öôÔ∏è Execution Workflow

### Summary Steps
1. Parse input (image or text) ‚Üí structured Markdown
2. Generate Bundle JSON from Markdown
3. Run integrity check (`validate_bundle_integrity.py`)
4. Save `<id>.bundle.orig.json`
5. Run integrity checks + autofix
6. Validate with HL7 Validator
7. Iterate autofix ‚Üí validate ‚â§ 3 times
8. Output final Bundle + logs into `/guidelines/<base>/`

### Acceptance Criteria
- ‚úÖ `validator_cli.jar` returns **0 errors**
- ‚úÖ Bundle includes PlanDefinition, Library, Questionnaire, ActivityDefinition
- ‚úÖ Canonicals and fullUrls are consistent
- ‚úÖ Library.type + Library.content present
- ‚úÖ All autofix and validation logs preserved
- ‚úÖ `validate_bundle_integrity.py` passes without critical errors
- ‚úÖ Output files organized within `/guidelines/<base>/`

---

## üß∞ Implementation Guidelines
- **Languages:** Python or Node.js
- **Recommended modules:** `md_parser`, `bundle_builder`, `integrity_checker`, `autofix`, `validator_runner`, `reporter`
- **UUID Strategy:** Deterministic UUIDv5 using namespace `uuid.NAMESPACE_URL` and name `<bundle-id>|<resourceType>|<resource-id>`
- **Test cases:**
  - ‚úÖ Happy path ‚Äî valid Markdown ‚Üí passes first validation
  - ‚ö†Ô∏è Missing fullUrl ‚Äî fixed automatically
  - ‚ö†Ô∏è Missing Library.type/content ‚Äî fixed automatically
  - ‚öôÔ∏è Integrity check ‚Äî detects missing references or IDs before validation

---

## üì¶ Deliverables Checklist
- [ ] `/guidelines/<base>/<base>.md`
- [ ] `/guidelines/<base>/<base>.bundle.orig.json`
- [ ] `/guidelines/<base>/<base>.bundle.json`
- [ ] `/guidelines/<base>/<base>.integrity.report.txt`
- [ ] `/guidelines/<base>/<base>.bundle.report.txt`
- [ ] `/guidelines/<base>/<base>.bundle.autofix.log`
- [ ] `/guidelines/<base>/<base>.bundle.remediation.txt` (if needed)

---

## üßæ Change Log
- v2.3.0 ‚Äî Added directory organization structure under `/guidelines/<base>/` for all output files

